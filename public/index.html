<html>
  <head>
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="style/main.css"></link>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  </head>
  <body>
    <div class="page-header" id="header">
      <h1>NodeChat</h1>
      <p>Users online: <span id="user-count">0</span></p>
    </div>
    <div id="chat"></div>
    <div class="input-group" id="chatInput">
      <input id="input" type="text" class="form-control" aria-label="glyphicon glyphicon-arrow-right">
      <span class="input-group-btn">
        <button class="btn btn-default" id="inputButton" type="button">Send</button>
      </span>
    </div>

    <div class="modal fade" id="setUsername" tabindex="-1" role="dialog" aria-labelledby="setUsernameLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="setUsernameLabel">Welcome to NodeChat!</h4>
        </div>
        <div class="modal-body">
          <div class="input-group">
            <input type="text" id="setUsernameInput" class="form-control" placeholder="Enter a username...">
            <span class="input-group-btn">
              <button class="btn btn-default" id="setUsernameButton" type="button">Go!</button>
            </span>
          </div>
        </div>
        <div class="alert alert-danger" id="empty-warning" hidden="true" role="alert">Your username cannot be empty silly :)</div>
      </div>
    </div>
  </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();
      $(document).ready(function(){
        $('#setUsername').modal('show');
        setTimeout(function(){
          $("#setUsernameInput").focus();
        }, 500);
      });
      $("#input").keypress(function(e){
        if(e.which == 13) sendMessage();
      });
      $("#inputButton").on('click', function(){
        sendMessage();
      });

      function sendMessage(){
        socket.emit('chat message', $("#input").val());
        $('#input').val('');
        return false;
      }

      $("#setUsernameButton").on('click', function(){changeUsername()});
      $("#setUsernameInput").keypress(function (e) {
        if(e.which == 13) changeUsername();
      });

      function changeUsername(){
        var newName = $("#setUsernameInput").val();
        if(newName){
          socket.emit('username change', newName);
          $("#setUsername").modal('hide');
          $("#input").focus();
        }else{
          $("#empty-warning").show();
        }
      }
      socket.on("chat message", function(msg){
        $('#chat').append($("<li>").text(msg));
        var chat = $("#chat");
        chat.animate({scrollTop: chat.prop("scrollHeight") - chat.height()}, 100);
      });

      socket.on("user change", function (count) {
        $("#user-count").text(count);
      });

      socket.on("chat history", function (messages) {
        var msgArray = messages.split(',');
        for(var i = 0; i < msgArray.length; i++){
          $('#chat').append($("<li>").text(msgArray[i]));
        }
        var chat = $("#chat");
        chat.animate({scrollTop: chat.prop("scrollHeight") - chat.height()}, 100);
      });
    </script>
  </body>
</html>
